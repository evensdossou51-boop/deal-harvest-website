<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Import - Your Products</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .btn { background: #007bff; color: white; padding: 15px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üöÄ Quick Import from Your Google Sheet</h1>
    <p><strong>Sheet ID:</strong> 10mH0CmZH289z_8sTekXWWuNvivDNn9bhi6hEbhgMZic</p>
    <p><a href="https://docs.google.com/spreadsheets/d/10mH0CmZH289z_8sTekXWWuNvivDNn9bhi6hEbhgMZic/edit?usp=sharing" target="_blank">üìä Open Your Google Sheet</a></p>
    
    <button class="btn" onclick="importProducts()">üì• Import Products Now</button>
    
    <div id="result"></div>

    <script>
        async function importProducts() {
            const resultDiv = document.getElementById('result');
            const btn = event.target;
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Importing...';
            
            try {
                const sheetId = '10mH0CmZH289z_8sTekXWWuNvivDNn9bhi6hEbhgMZic';
                const sheetName = 'Sheet1';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${sheetName}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}. Make sure your Google Sheet is publicly accessible.`);
                }
                
                const csvText = await response.text();
                console.log('Raw CSV:', csvText); // Debug log
                
                const products = convertCSVToJSON(csvText);
                
                if (products.length === 0) {
                    throw new Error('No valid products found in the sheet. Make sure you have data in rows 2 and beyond.');
                }

                // Download the products.json file
                const jsonString = JSON.stringify(products, null, 4);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = 'products.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

                resultDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Success!</h3>
                        <p>Imported <strong>${products.length}</strong> products from your Google Sheet.</p>
                        <p>The <code>products.json</code> file has been downloaded.</p>
                        <p><strong>Next step:</strong> Replace the <code>products.json</code> file in your website folder with the downloaded one.</p>
                    </div>
                    <h3>Preview of imported products:</h3>
                    <pre>${jsonString}</pre>
                `;
                
            } catch (error) {
                console.error('Import error:', error);
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Import Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <h4>Common solutions:</h4>
                        <ul>
                            <li>Make sure your Google Sheet is set to "Anyone with the link can view"</li>
                            <li>Check that your sheet has the correct column headers in row 1</li>
                            <li>Ensure you have data in row 2 and beyond</li>
                            <li>Verify the sheet name is "Sheet1" (or update the script)</li>
                        </ul>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì• Import Products Now';
            }
        }

        function convertCSVToJSON(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                throw new Error('Sheet appears empty or only has headers');
            }

            const products = [];
            
            // Skip header row (line 0), process data rows
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                // Skip if not enough columns
                if (values.length < 9) {
                    console.log(`Skipping row ${i + 1}: insufficient columns`);
                    continue;
                }
                
                // Skip if essential fields are empty
                if (!values[1] || !values[8]) { // name or affiliate link missing
                    console.log(`Skipping row ${i + 1}: missing essential data`);
                    continue;
                }
                
                // Handle image - check if it's a full URL or just filename
                let imageValue = cleanValue(values[7]) || 'placeholder.jpg';
                if (imageValue && !imageValue.startsWith('http') && !imageValue.startsWith('images/')) {
                    imageValue = imageValue; // Keep as filename for images/ folder
                }

                const product = {
                    id: parseInt(values[0]) || i,
                    name: cleanValue(values[1]),
                    description: cleanValue(values[2]) || 'No description available',
                    originalPrice: parseFloat(values[3]) || 0,
                    salePrice: parseFloat(values[4]) || parseFloat(values[3]) || 0,
                    store: cleanValue(values[5]) || 'amazon',
                    category: cleanValue(values[6]) || 'electronics',
                    image: imageValue,
                    affiliateLink: cleanValue(values[8])
                };
                
                products.push(product);
            }
            
            return products;
        }

        function cleanValue(value) {
            if (!value) return '';
            return value.replace(/^["']|["']$/g, '').trim();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
    </script>
</body>
</html>